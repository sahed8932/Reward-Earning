<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reward Earn Pro</title>
    
    <!-- Ad Code (Monetag) -->
    <script src='//libtl.com/sdk.js' data-zone='10352978' data-sdk='show_10352978'></script>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #ffffff; overflow-x: hidden; user-select: none; }
        ::-webkit-scrollbar { width: 0px; }
        .btn-primary { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-weight: bold; transition: all 0.2s; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); }
        .btn-primary:active { transform: scale(0.96); }
        .btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .input-field { background-color: #1e293b; border: 1px solid #334155; color: white; transition: all 0.3s ease; }
        .input-field:focus { border-color: #f59e0b; outline: none; }
        .page-section { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .page-section.active { display: flex; opacity: 1; }
        .sub-page { display: none; animation: slideUp 0.3s ease-out; }
        .sub-page.active { display: block; }
        .bottom-nav { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); border-top: 1px solid #334155; }
        .nav-link.active { color: #f59e0b; }
        .nav-link.active i { transform: translateY(-3px); }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .task-btn { position: relative; overflow: hidden; }
        .task-btn::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: 0.5s; }
        .task-btn:hover::after { left: 100%; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen relative bg-slate-900 pb-20">

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-yellow-500 mb-4"></div>
        <p class="text-yellow-500 font-bold text-sm tracking-widest animate-pulse">LOADING SYSTEM</p>
    </div>

    <!-- Auth Section -->
    <div id="auth-section" class="min-h-screen flex-col justify-center items-center page-section z-50 p-6">
        <div class="glass-card p-8 rounded-2xl w-full max-w-sm shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-yellow-500 to-transparent"></div>
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-14 h-14 rounded-xl bg-yellow-500/20 mb-3">
                    <i data-lucide="zap" class="w-8 h-8 text-yellow-500"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">Earn Pro BD</h1>
                <p class="text-gray-400 text-xs">Monetize your time professionally</p>
            </div>

            <!-- Login -->
            <div id="login-view" class="space-y-4">
                <input id="login-email" type="email" class="w-full p-3 rounded-lg input-field" placeholder="Email Address">
                <input id="login-password" type="password" class="w-full p-3 rounded-lg input-field" placeholder="Password">
                <button id="login-btn" class="w-full p-3 rounded-lg btn-primary mt-2">SECURE LOGIN</button>
                <p class="text-center text-sm text-gray-400 mt-4">New here? <a href="#" id="show-signup" class="text-yellow-500 hover:underline">Create Account</a></p>
            </div>

            <!-- Signup -->
            <div id="signup-view" class="hidden space-y-4">
                <input id="signup-name" type="text" class="w-full p-3 rounded-lg input-field" placeholder="Full Name">
                <input id="signup-email" type="email" class="w-full p-3 rounded-lg input-field" placeholder="Email Address">
                <input id="signup-password" type="password" class="w-full p-3 rounded-lg input-field" placeholder="Create Password">
                <div class="relative">
                     <input id="signup-referral" type="text" class="w-full p-3 rounded-lg input-field uppercase" placeholder="Referral Code (Optional)">
                     <i data-lucide="gift" class="absolute right-3 top-3.5 w-5 h-5 text-gray-500"></i>
                </div>
                <button id="signup-btn" class="w-full p-3 rounded-lg btn-primary mt-2">REGISTER ACCOUNT</button>
                <p class="text-center text-sm text-gray-400 mt-4">Have account? <a href="#" id="show-login" class="text-yellow-500 hover:underline">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="min-h-screen flex-col page-section relative z-10">
        <!-- Header -->
        <header class="flex items-center justify-between p-5 sticky top-0 bg-slate-900/90 backdrop-blur-md z-40 border-b border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-yellow-500 rounded-lg flex items-center justify-center font-bold text-slate-900">P</div>
                <div>
                    <h1 class="text-sm font-bold text-white">Earn Pro</h1>
                    <p class="text-[10px] text-gray-400" id="header-user-name">Welcome back</p>
                </div>
            </div>
            <div class="bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700 flex items-center gap-2">
                <i data-lucide="coins" class="w-4 h-4 text-yellow-500"></i>
                <span id="header-balance" class="font-bold text-sm">0</span>
            </div>
        </header>

        <main class="flex-grow p-4">
            
            <!-- Home Dashboard -->
            <div id="home-page" class="sub-page active space-y-6">
                <!-- Balance Card -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-slate-700 relative overflow-hidden shadow-xl">
                    <div class="absolute right-[-20px] top-[-20px] w-32 h-32 bg-yellow-500/10 rounded-full blur-2xl"></div>
                    <p class="text-gray-400 text-xs uppercase tracking-wider">Current Balance</p>
                    <div class="flex items-end gap-2 mt-1">
                        <h2 class="text-4xl font-bold text-white" id="main-balance">0.00</h2>
                        <span class="text-yellow-500 font-medium mb-1">Coins</span>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button onclick="navigateTo('wallet-page')" class="flex-1 bg-yellow-500 hover:bg-yellow-400 text-slate-900 py-2 rounded-lg text-sm font-bold">Withdraw</button>
                        <button onclick="navigateTo('refer-page')" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-sm font-bold">Invite</button>
                    </div>
                </div>

                <!-- Daily Tasks Grid -->
                <div>
                    <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                        <i data-lucide="target" class="text-yellow-500 w-5 h-5"></i> Daily Tasks
                    </h3>
                    <div class="grid grid-cols-1 gap-4">
                        
                        <!-- Task 1 -->
                        <div class="glass-card p-4 rounded-xl border-l-4 border-l-blue-500">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-bold">Ad Task 1</h4>
                                    <p class="text-xs text-gray-400">Watch full ad to claim</p>
                                </div>
                                <span class="bg-slate-800 text-blue-400 text-xs px-2 py-1 rounded font-mono">
                                    <span id="task1-count">0</span>/10
                                </span>
                            </div>
                            <div class="w-full bg-slate-800 h-1.5 rounded-full mb-3">
                                <div id="task1-progress" class="bg-blue-500 h-1.5 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                            <button id="btn-task1" onclick="handleTask('task1', 50)" class="w-full py-2.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold task-btn">START TASK</button>
                        </div>

                        <!-- Task 2 -->
                        <div class="glass-card p-4 rounded-xl border-l-4 border-l-purple-500">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-bold">Ad Task 2</h4>
                                    <p class="text-xs text-gray-400">Interact and earn</p>
                                </div>
                                <span class="bg-slate-800 text-purple-400 text-xs px-2 py-1 rounded font-mono">
                                    <span id="task2-count">0</span>/10
                                </span>
                            </div>
                            <div class="w-full bg-slate-800 h-1.5 rounded-full mb-3">
                                <div id="task2-progress" class="bg-purple-500 h-1.5 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                            <button id="btn-task2" onclick="handleTask('task2', 50)" class="w-full py-2.5 rounded-lg bg-purple-600 hover:bg-purple-500 text-white text-sm font-bold task-btn">START TASK</button>
                        </div>

                         <!-- Task 3 (Math) -->
                         <div class="glass-card p-4 rounded-xl border-l-4 border-l-green-500">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-bold">Math Quiz</h4>
                                    <p class="text-xs text-gray-400">Solve & Watch Ad</p>
                                </div>
                                <span class="bg-slate-800 text-green-400 text-xs px-2 py-1 rounded font-mono">
                                    <span id="task3-count">0</span>/10
                                </span>
                            </div>
                            <div class="w-full bg-slate-800 h-1.5 rounded-full mb-3">
                                <div id="task3-progress" class="bg-green-500 h-1.5 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                            <button id="btn-task3" onclick="handleMathTask()" class="w-full py-2.5 rounded-lg bg-green-600 hover:bg-green-500 text-white text-sm font-bold task-btn">START QUIZ</button>
                        </div>

                         <!-- Task 4 (Spin) -->
                         <div class="glass-card p-4 rounded-xl border-l-4 border-l-pink-500">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-bold">Lucky Spin</h4>
                                    <p class="text-xs text-gray-400">Try your luck</p>
                                </div>
                                <span class="bg-slate-800 text-pink-400 text-xs px-2 py-1 rounded font-mono">
                                    <span id="task4-count">0</span>/10
                                </span>
                            </div>
                            <div class="w-full bg-slate-800 h-1.5 rounded-full mb-3">
                                <div id="task4-progress" class="bg-pink-500 h-1.5 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                            <button id="btn-task4" onclick="handleTask('task4', 100)" class="w-full py-2.5 rounded-lg bg-pink-600 hover:bg-pink-500 text-white text-sm font-bold task-btn">SPIN NOW</button>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Wallet Page -->
            <div id="wallet-page" class="sub-page space-y-6">
                <div class="text-center py-6">
                    <p class="text-gray-400 text-sm">Withdrawable Balance</p>
                    <h3 class="text-4xl font-bold text-yellow-500 mt-2"><span id="wallet-balance">0</span></h3>
                    <div class="inline-block bg-slate-800 px-3 py-1 rounded-full text-xs text-gray-400 mt-2 border border-slate-700">
                        Rate: 1000 Coins = 10 BDT
                    </div>
                </div>
                
                <div class="glass-card p-5 rounded-xl space-y-4">
                    <h3 class="font-bold border-b border-slate-700 pb-2">Request Withdrawal</h3>
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">Payment Method</label>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="method-select p-3 rounded-lg border border-slate-700 text-center cursor-pointer hover:border-yellow-500 bg-slate-800" onclick="selectMethod(this, 'bKash')">bKash</div>
                            <div class="method-select p-3 rounded-lg border border-slate-700 text-center cursor-pointer hover:border-yellow-500 bg-slate-800" onclick="selectMethod(this, 'Nagad')">Nagad</div>
                            <div class="method-select p-3 rounded-lg border border-slate-700 text-center cursor-pointer hover:border-yellow-500 bg-slate-800" onclick="selectMethod(this, 'Recharge')">TopUp</div>
                        </div>
                        <input type="hidden" id="selected-method">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">Account Number</label>
                        <input id="withdraw-number" type="number" class="w-full p-3 rounded-lg input-field" placeholder="017xxxxxxxx">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">Amount (Coins)</label>
                        <input id="withdraw-amount" type="number" class="w-full p-3 rounded-lg input-field" placeholder="Min 5000">
                    </div>
                    <button id="withdraw-btn" class="w-full btn-primary py-3 rounded-lg mt-2">CONFIRM WITHDRAW</button>
                </div>

                <div>
                    <h3 class="font-bold mb-3 text-sm text-gray-400">Transaction History</h3>
                    <div id="history-list" class="space-y-3">
                        <!-- History loaded via JS -->
                    </div>
                </div>
            </div>

            <!-- Refer Page -->
            <div id="refer-page" class="sub-page space-y-6 text-center">
                <div class="glass-card p-6 rounded-2xl border border-dashed border-yellow-500/30">
                    <div class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-yellow-500/20">
                        <i data-lucide="share-2" class="w-8 h-8 text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold">Invite Friends</h2>
                    <p class="text-gray-400 text-sm mt-2 mb-6">Earn <span class="text-yellow-500 font-bold">200 Coins</span> for every successful referral.</p>
                    
                    <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 mb-4">
                        <p class="text-xs text-gray-500 mb-1 uppercase">Your Referral Code</p>
                        <div class="flex items-center justify-center gap-3">
                            <span id="refer-code-display" class="text-2xl font-mono font-bold text-white tracking-widest">LOADING</span>
                            <button onclick="copyCode()" class="text-yellow-500 hover:text-white transition"><i data-lucide="copy" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    
                    <button onclick="copyLink()" class="w-full bg-slate-800 border border-slate-600 hover:bg-slate-700 text-white py-3 rounded-lg flex items-center justify-center gap-2 mb-2 font-medium">
                        <i data-lucide="link" class="w-4 h-4"></i> Copy Referral Link
                    </button>
                    <button onclick="shareLink()" class="w-full btn-primary py-3 rounded-lg font-bold">SHARE NOW</button>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile-page" class="sub-page space-y-5">
                <div class="glass-card p-6 rounded-2xl flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full bg-slate-800 border-2 border-yellow-500 overflow-hidden">
                        <img id="profile-img" src="" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h2 id="profile-name" class="text-lg font-bold">User Name</h2>
                        <p id="profile-email" class="text-xs text-gray-400">user@email.com</p>
                        <span class="inline-block mt-2 bg-yellow-500/20 text-yellow-500 text-[10px] px-2 py-0.5 rounded font-bold">PRO MEMBER</span>
                    </div>
                </div>

                <div class="space-y-2">
                    <a href="https://t.me/your_telegram_channel" target="_blank" class="block glass-card p-4 rounded-xl hover:bg-slate-800 transition flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i data-lucide="send" class="w-5 h-5 text-blue-400"></i>
                            <span>Join Telegram</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-500"></i>
                    </a>
                    <button onclick="signOut(auth)" class="w-full glass-card p-4 rounded-xl hover:bg-red-500/10 transition flex justify-between items-center text-red-400">
                        <div class="flex items-center gap-3">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                            <span>Logout Account</span>
                        </div>
                    </button>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav fixed bottom-0 w-full max-w-md left-1/2 -translate-x-1/2 grid grid-cols-4 py-3 z-50">
            <button class="nav-link active flex flex-col items-center gap-1" onclick="navigateTo('home-page')">
                <i data-lucide="layout-grid" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">HOME</span>
            </button>
            <button class="nav-link flex flex-col items-center gap-1" onclick="navigateTo('wallet-page')">
                <i data-lucide="wallet" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">WALLET</span>
            </button>
            <button class="nav-link flex flex-col items-center gap-1" onclick="navigateTo('refer-page')">
                <i data-lucide="users" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">INVITE</span>
            </button>
            <button class="nav-link flex flex-col items-center gap-1" onclick="navigateTo('profile-page')">
                <i data-lucide="user-circle" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">PROFILE</span>
            </button>
        </nav>
    </div>

    <!-- Math Quiz Modal -->
    <div id="math-modal" class="fixed inset-0 bg-black/90 z-[60] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-xs text-center border border-slate-700 animate-bounce-in">
            <h3 class="text-xl font-bold mb-4 text-white">Solve to Earn</h3>
            <div class="bg-slate-900 p-4 rounded-lg mb-4 text-2xl font-mono font-bold text-yellow-500 border border-slate-700">
                <span id="math-q">5 + 3</span> = ?
            </div>
            <input type="number" id="math-ans" class="w-full p-3 rounded-lg bg-slate-700 text-white text-center mb-4 focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="Enter Answer">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeMathModal()" class="bg-slate-600 text-white py-2 rounded-lg font-bold">Cancel</button>
                <button onclick="submitMath()" class="btn-primary py-2 rounded-lg">Submit</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl border border-slate-700 flex items-center gap-3 z-[100] translate-y-[-100px] transition-all duration-300">
        <i data-lucide="info" class="text-yellow-500 w-5 h-5"></i>
        <span id="toast-msg" class="text-sm font-medium">Notification</span>
    </div>

    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDSyXdeWqDD-3OFNZT6SMcJz0Nr7tSdTS0",
          authDomain: "reward-earn-money-32b24.firebaseapp.com",
          databaseURL: "https://reward-earn-money-32b24-default-rtdb.firebaseio.com",
          projectId: "reward-earn-money-32b24",
          storageBucket: "reward-earn-money-32b24.firebasestorage.app",
          messagingSenderId: "647603026182",
          appId: "1:647603026182:web:1bfe0a9dc3d8e4513f8687"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Expose auth for HTML button
        window.signOut = signOut;

        // Globals
        let currentUser = null;
        let userData = null;
        let activeTask = null; // Stores which task is currently being done
        let mathAnswer = 0;
        const taskLimits = { task1: 10, task2: 10, task3: 10, task4: 10 };

        // UI Helpers
        window.showToast = (msg, type = 'info') => {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.style.transform = "translate(-50%, 0)";
            setTimeout(() => toast.style.transform = "translate(-50%, -100px)", 3000);
        };

        window.navigateTo = (pageId) => {
            document.querySelectorAll('.sub-page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // Nav Active State
            document.querySelectorAll('.nav-link').forEach(btn => {
                btn.classList.remove('active');
                if(btn.getAttribute('onclick').includes(pageId)) btn.classList.add('active');
            });

            if(pageId === 'wallet-page') loadHistory();
            lucide.createIcons();
        };

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('loader');
            if (user) {
                currentUser = user;
                try {
                    await fetchUserData();
                    document.getElementById('auth-section').classList.remove('active');
                    document.getElementById('app-container').classList.add('active');
                } catch(e) { console.error(e); }
            } else {
                currentUser = null;
                // Check Referral Link on Load
                const urlParams = new URLSearchParams(window.location.search);
                const refCode = urlParams.get('ref');
                if(refCode) {
                    document.getElementById('signup-referral').value = refCode;
                    document.getElementById('show-signup').click();
                }

                document.getElementById('app-container').classList.remove('active');
                document.getElementById('auth-section').classList.add('active');
            }
            loader.style.display = 'none';
        });

        async function fetchUserData() {
            if (!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            const snap = await getDoc(userRef);
            
            if (snap.exists()) {
                userData = snap.data();
                // Check if new day, reset counters
                const today = new Date().toISOString().split('T')[0];
                if (userData.lastActiveDate !== today) {
                    userData.taskCounters = { task1: 0, task2: 0, task3: 0, task4: 0 };
                    userData.lastActiveDate = today;
                    await updateDoc(userRef, { taskCounters: userData.taskCounters, lastActiveDate: today });
                }
            } else {
                // First Time Setup
                userData = {
                    uid: currentUser.uid,
                    name: currentUser.email.split('@')[0],
                    email: currentUser.email,
                    balance: 50,
                    referralCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
                    taskCounters: { task1: 0, task2: 0, task3: 0, task4: 0 },
                    lastActiveDate: new Date().toISOString().split('T')[0],
                    createdAt: serverTimestamp()
                };
                await setDoc(userRef, userData);
            }
            updateUI();
        }

        function updateUI() {
            if(!userData) return;
            // Balance
            document.getElementById('header-balance').innerText = userData.balance;
            document.getElementById('main-balance').innerText = userData.balance.toFixed(2);
            document.getElementById('wallet-balance').innerText = userData.balance.toFixed(2);
            
            // Profile
            document.getElementById('header-user-name').innerText = userData.name;
            document.getElementById('profile-name').innerText = userData.name;
            document.getElementById('profile-email').innerText = userData.email;
            document.getElementById('profile-img').src = `https://ui-avatars.com/api/?name=${userData.name}&background=f59e0b&color=fff`;
            document.getElementById('refer-code-display').innerText = userData.referralCode;

            // Tasks Counters
            ['task1', 'task2', 'task3', 'task4'].forEach(task => {
                const count = userData.taskCounters ? userData.taskCounters[task] || 0 : 0;
                document.getElementById(`${task}-count`).innerText = count;
                // Update Progress Bar
                const pct = (count / 10) * 100;
                document.getElementById(`${task}-progress`).style.width = `${pct}%`;
                
                // Reset Button State if needed
                const btn = document.getElementById(`btn-${task}`);
                if(btn.dataset.state === 'claim') {
                    // keep claim state
                } else {
                    if (count >= 10) {
                        btn.innerText = "COMPLETED";
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        btn.innerText = "START TASK"; // Reset text
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-primary');
                    }
                }
            });
            lucide.createIcons();
        }

        // --- AUTH HANDLERS ---
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            if(!email || !pass) return showToast("Fill all fields");
            document.getElementById('loader').style.display = 'flex';
            try { await signInWithEmailAndPassword(auth, email, pass); }
            catch(e) { showToast(e.message); document.getElementById('loader').style.display = 'none'; }
        });

        document.getElementById('signup-btn').addEventListener('click', async () => {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-password').value;
            const refCode = document.getElementById('signup-referral').value.trim().toUpperCase();

            if(!name || !email || !pass) return showToast("Fill all fields");
            document.getElementById('loader').style.display = 'flex';

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const newUser = {
                    uid: cred.user.uid,
                    name: name,
                    email: email,
                    balance: 50,
                    referralCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
                    referredBy: refCode || null,
                    taskCounters: { task1: 0, task2: 0, task3: 0, task4: 0 },
                    lastActiveDate: new Date().toISOString().split('T')[0],
                    createdAt: serverTimestamp()
                };
                await setDoc(doc(db, "users", cred.user.uid), newUser);
                
                // Handle Referral Bonus
                if(refCode) {
                    const q = query(collection(db, "users"), where("referralCode", "==", refCode));
                    const snap = await getDocs(q);
                    if(!snap.empty) {
                        const referrerRef = snap.docs[0].ref;
                        await updateDoc(referrerRef, { balance: (snap.docs[0].data().balance || 0) + 200 });
                    }
                }
            } catch(e) { 
                showToast(e.message); 
                document.getElementById('loader').style.display = 'none'; 
            }
        });

        // Toggle Auth View
        document.getElementById('show-signup').onclick = () => { document.getElementById('login-view').classList.add('hidden'); document.getElementById('signup-view').classList.remove('hidden'); };
        document.getElementById('show-login').onclick = () => { document.getElementById('signup-view').classList.add('hidden'); document.getElementById('login-view').classList.remove('hidden'); };

        // --- TASK SYSTEM (CLAIM LOGIC) ---
        window.handleTask = async (taskId, reward) => {
            const btn = document.getElementById(`btn-${taskId}`);
            const currentCount = userData.taskCounters[taskId] || 0;

            // 1. Check Limit
            if (currentCount >= 10) return showToast("Daily limit reached for this task!");

            // 2. Check State (Start vs Claim)
            if (btn.dataset.state === 'claim') {
                // --- CLAIM PHASE ---
                btn.innerText = "ADDING...";
                try {
                    const newBalance = userData.balance + reward;
                    const newCounters = { ...userData.taskCounters, [taskId]: currentCount + 1 };
                    
                    await updateDoc(doc(db, "users", currentUser.uid), {
                        balance: newBalance,
                        taskCounters: newCounters
                    });

                    userData.balance = newBalance;
                    userData.taskCounters = newCounters;
                    
                    // Reset Button
                    delete btn.dataset.state;
                    btn.classList.remove('btn-success');
                    updateUI();
                    showToast(`Success! +${reward} coins added.`);
                } catch(e) {
                    showToast("Network error. Try again.");
                    delete btn.dataset.state;
                    updateUI();
                }
            } else {
                // --- START PHASE (Ad Show) ---
                if (typeof window.show_10352978 !== 'function') return showToast("Ad is loading... wait 5s");
                
                btn.innerText = "Loading Ad...";
                try {
                    // Show Monetag Ad
                    await window.show_10352978().catch(e => console.log("Ad closed/skipped"));
                    
                    // Ad Finished - Change Button to CLAIM
                    btn.innerText = "CLAIM REWARD";
                    btn.classList.remove('btn-primary'); // remove orange/blue
                    btn.classList.add('btn-success'); // add green
                    btn.dataset.state = 'claim'; // Mark as ready to claim
                    
                } catch(e) {
                    console.log(e);
                    btn.innerText = "START TASK"; // Revert
                    showToast("Failed to load ad.");
                }
            }
        };

        // --- MATH QUIZ LOGIC ---
        window.handleMathTask = () => {
            if(userData.taskCounters.task3 >= 10) return showToast("Limit reached!");
            const n1 = Math.floor(Math.random() * 10) + 1;
            const n2 = Math.floor(Math.random() * 10) + 1;
            mathAnswer = n1 + n2;
            document.getElementById('math-q').innerText = `${n1} + ${n2}`;
            document.getElementById('math-ans').value = '';
            document.getElementById('math-modal').classList.remove('hidden');
        };

        window.closeMathModal = () => document.getElementById('math-modal').classList.add('hidden');
        
        window.submitMath = async () => {
            const ans = parseInt(document.getElementById('math-ans').value);
            if(ans === mathAnswer) {
                closeMathModal();
                // Trigger Ad flow for Math Task (task3)
                // Use handleTask logic manually or pass flag
                await handleTask('task3', 50); 
            } else {
                showToast("Wrong Answer!");
            }
        };

        // --- WITHDRAWAL & REFERRAL ---
        window.selectMethod = (el, method) => {
            document.querySelectorAll('.method-select').forEach(d => d.classList.remove('border-yellow-500', 'text-yellow-500'));
            el.classList.add('border-yellow-500', 'text-yellow-500');
            document.getElementById('selected-method').value = method;
        };

        document.getElementById('withdraw-btn').onclick = async () => {
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            const number = document.getElementById('withdraw-number').value;
            const method = document.getElementById('selected-method').value;

            if(!amount || !number || !method) return showToast("Please fill all details");
            if(amount < 5000) return showToast("Minimum withdrawal is 5000 coins");
            if(amount > userData.balance) return showToast("Insufficient balance");

            try {
                // Deduct Balance
                await updateDoc(doc(db, "users", currentUser.uid), { balance: userData.balance - amount });
                userData.balance -= amount;
                
                // Add History
                await addDoc(collection(db, "withdrawals"), {
                    userId: currentUser.uid,
                    amount, method, number,
                    status: 'pending',
                    date: serverTimestamp()
                });
                
                updateUI();
                showToast("Withdrawal Request Submitted!");
                loadHistory();
                document.getElementById('withdraw-amount').value = "";
            } catch(e) { showToast(e.message); }
        };

        async function loadHistory() {
            const list = document.getElementById('history-list');
            const q = query(collection(db, "withdrawals"), where("userId", "==", currentUser.uid), orderBy("date", "desc"), limit(5));
            try {
                const snap = await getDocs(q);
                list.innerHTML = "";
                if(snap.empty) list.innerHTML = "<p class='text-center text-xs text-gray-500'>No transactions yet.</p>";
                snap.forEach(d => {
                    const data = d.data();
                    let color = data.status === 'paid' ? 'text-green-400' : 'text-yellow-400';
                    list.innerHTML += `
                    <div class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700">
                        <div>
                            <p class="font-bold text-sm text-white">${data.method}</p>
                            <p class="text-[10px] text-gray-400">${data.number}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${color}">${data.amount}</p>
                            <p class="text-[10px] uppercase text-gray-500">${data.status}</p>
                        </div>
                    </div>`;
                });
            } catch(e) { console.log("Index needed for sorting"); }
        }

        // --- NEW REFERRAL SYSTEM ---
        window.copyCode = () => {
            navigator.clipboard.writeText(userData.referralCode);
            showToast("Code Copied!");
        };
        
        window.copyLink = () => {
            const link = `${window.location.origin}${window.location.pathname}?ref=${userData.referralCode}`;
            navigator.clipboard.writeText(link);
            showToast("Referral Link Copied!");
        };

        window.shareLink = () => {
            const link = `${window.location.origin}${window.location.pathname}?ref=${userData.referralCode}`;
            if(navigator.share) {
                navigator.share({
                    title: 'Earn Money Online',
                    text: 'Join now and earn money daily! Use my link:',
                    url: link
                });
            } else {
                copyLink();
            }
        };

        // Initialize Icons
        lucide.createIcons();
    </script>
</body>
</html>        .bubbles li { position: absolute; display: block; list-style: none; width: 20px; height: 20px; background: rgba(251, 191, 36, 0.15); animation: floatUp 25s linear infinite; bottom: -150px; border-radius: 50%; }
        .bubbles li:nth-child(1){ left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .bubbles li:nth-child(2){ left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        .bubbles li:nth-child(3){ left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        @keyframes floatUp { 0%{ transform: translateY(0) rotate(0deg); opacity: 1; } 100%{ transform: translateY(-1000px) rotate(720deg); opacity: 0; } }
        .notification-dot { position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; display: none; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen relative bg-slate-900">

    <ul class="bubbles"><li></li><li></li><li></li><li></li><li></li></ul>

    <!-- App Loader -->
    <div id="loader" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-yellow-400 mb-4"></div>
        <p class="text-yellow-400 font-bold animate-pulse">Loading...</p>
    </div>

    <!-- Auth Section -->
    <div id="auth-section" class="min-h-screen p-6 flex-col justify-center items-center page-section z-10">
        <div class="bg-slate-800/80 backdrop-blur-md p-8 rounded-2xl w-full max-w-sm border border-slate-700 shadow-2xl">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-yellow-400/20 mb-4">
                    <i data-lucide="coins" class="w-8 h-8 text-yellow-400"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">Reward Earn Bd</h1>
            </div>

            <!-- Login View -->
            <div id="login-view" class="space-y-4">
                <div class="space-y-2">
                    <label class="text-xs text-gray-400 uppercase">Email</label>
                    <input id="login-email" type="email" class="w-full p-3 rounded-xl input-field" placeholder="user@email.com">
                </div>
                <div class="space-y-2">
                    <label class="text-xs text-gray-400 uppercase">Password</label>
                    <input id="login-password" type="password" class="w-full p-3 rounded-xl input-field" placeholder="••••••••">
                </div>
                <button id="login-btn" class="w-full p-3 rounded-xl btn-accent mt-4">LOG IN</button>
                <p class="text-center text-sm text-gray-400 mt-4">No account? <a href="#" id="show-signup" class="text-yellow-400 font-bold">Sign Up</a></p>
            </div>

            <!-- Signup View -->
            <div id="signup-view" class="hidden space-y-4">
                <div class="space-y-2">
                    <label class="text-xs text-gray-400 uppercase">Name</label>
                    <input id="signup-name" type="text" class="w-full p-3 rounded-xl input-field" placeholder="Your Name">
                </div>
                <div class="space-y-2">
                    <label class="text-xs text-gray-400 uppercase">Email</label>
                    <input id="signup-email" type="email" class="w-full p-3 rounded-xl input-field" placeholder="user@email.com">
                </div>
                <div class="space-y-2">
                    <label class="text-xs text-gray-400 uppercase">Password</label>
                    <input id="signup-password" type="password" class="w-full p-3 rounded-xl input-field" placeholder="Create password">
                </div>
                <button id="signup-btn" class="w-full p-3 rounded-xl btn-accent mt-4">CREATE ACCOUNT</button>
                <p class="text-center text-sm text-gray-400 mt-4">Has account? <a href="#" id="show-login" class="text-yellow-400 font-bold">Log In</a></p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="min-h-screen flex-col page-section relative z-10 pb-20">
        <header class="flex items-center justify-between p-4 sticky top-0 bg-slate-900/95 backdrop-blur-md z-20 border-b border-gray-800">
            <div class="flex items-center gap-2">
                <i data-lucide="coins" class="text-yellow-400 w-6 h-6"></i>
                <h1 class="text-lg font-bold text-white">Reward Earn Bd</h1>
            </div>
            <div id="notification-bell" class="relative cursor-pointer p-2 rounded-full hover:bg-slate-800">
                <i data-lucide="bell" class="w-5 h-5 text-gray-300"></i>
                <div id="notification-dot" class="notification-dot"></div>
            </div>
        </header>

        <main class="flex-grow">
            <!-- Home Page -->
            <div id="home-page" class="p-4 space-y-6 sub-page active">
                <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-6 rounded-2xl border border-slate-700 relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-yellow-500/10 rounded-full blur-3xl -mr-16 -mt-16"></div>
                    <div class="flex justify-between items-center relative z-10">
                        <div>
                            <p class="text-gray-400 text-sm">Total Balance</p>
                            <h2 class="text-3xl font-bold text-white"><span id="coin-balance">0</span> <span class="text-sm text-yellow-400">Coins</span></h2>
                        </div>
                        <button onclick="navigateTo('wallet-page')" class="bg-yellow-400 text-slate-900 font-bold px-4 py-2 rounded-lg text-sm hover:bg-yellow-300">Withdraw</button>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-end mb-4">
                        <h2 class="text-lg font-bold">Daily Tasks</h2>
                        <span class="text-xs bg-slate-800 px-2 py-1 rounded text-gray-400">Ads Left: <span id="ads-left-count" class="text-yellow-400 font-bold">0</span></span>
                    </div>
                    <div class="space-y-3">
                        <div onclick="claimReward('interstitial')" class="bg-gradient-to-r from-orange-600 to-red-600 p-4 rounded-xl flex justify-between items-center cursor-pointer active:scale-95 transition">
                            <div class="flex items-center gap-3">
                                <div class="bg-white/20 p-2 rounded"><i data-lucide="zap" class="text-white"></i></div>
                                <div><h3 class="font-bold">Watch Ad</h3><p class="text-xs opacity-80">+50 Coins</p></div>
                            </div>
                            <span class="bg-white text-orange-600 text-xs font-bold px-3 py-1 rounded">CLAIM</span>
                        </div>
                        <div onclick="claimReward('popup')" class="card-bg p-4 rounded-xl flex justify-between items-center cursor-pointer border-slate-700 hover:border-yellow-500/50 transition">
                            <div class="flex items-center gap-3">
                                <div class="bg-slate-800 p-2 rounded"><i data-lucide="gift" class="text-yellow-400"></i></div>
                                <div><h3 class="font-bold">Bonus Click</h3><p class="text-xs text-gray-400">+50 Coins</p></div>
                            </div>
                            <span class="bg-slate-700 text-white text-xs font-bold px-3 py-1 rounded">START</span>
                        </div>
                         <div onclick="claimReward('miniApp')" class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 rounded-xl flex justify-between items-center cursor-pointer active:scale-95 transition">
                            <div class="flex items-center gap-3">
                                <div class="bg-white/20 p-2 rounded"><i data-lucide="gamepad-2" class="text-white"></i></div>
                                <div><h3 class="font-bold">Play Game</h3><p class="text-xs opacity-80">+100 Coins</p></div>
                            </div>
                            <span class="bg-white text-blue-600 text-xs font-bold px-3 py-1 rounded">PLAY</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wallet Page -->
            <div id="wallet-page" class="p-4 space-y-6 sub-page">
                <div class="card-bg p-6 rounded-2xl text-center">
                    <p class="text-gray-400 text-sm">Withdrawable Balance</p>
                    <h3 class="text-3xl font-bold text-yellow-400 mt-1"><span id="wallet-coin-balance">0</span> Coins</h3>
                    <p id="coin-value-info" class="text-xs text-gray-500 mt-2">1000 Coins = 10 BDT</p>
                </div>
                <div class="space-y-4">
                    <input id="withdraw-amount" type="number" placeholder="Enter Amount (Min: 5000)" class="w-full p-3 rounded-xl input-field bg-slate-800">
                    <select id="withdraw-method" class="w-full p-3 rounded-xl input-field bg-slate-800">
                        <option value="" disabled selected>Select Payment Method</option>
                        <option value="bKash">bKash</option>
                        <option value="Nagad">Nagad</option>
                        <option value="Rocket">Rocket</option>
                    </select>
                    <input id="payment-number" type="number" placeholder="Enter Account Number" class="w-full p-3 rounded-xl input-field bg-slate-800">
                    <button id="withdraw-btn" class="w-full btn-accent py-3 rounded-xl">WITHDRAW REQUEST</button>
                </div>
                <div>
                    <h3 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="history" class="w-4 h-4"></i> History</h3>
                    <div id="withdrawal-history-list" class="space-y-2 text-sm text-gray-400">
                        <p class="text-center py-4">Loading history...</p>
                    </div>
                </div>
            </div>

            <!-- Refer Page -->
            <div id="refer-page" class="p-4 space-y-6 sub-page">
                <div class="text-center">
                    <div class="w-20 h-20 bg-yellow-400/10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="users" class="w-10 h-10 text-yellow-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold">Refer & Earn</h2>
                    <p class="text-gray-400 text-sm mt-2">Share your code and earn 100 coins per friend!</p>
                </div>
                <div class="card-bg p-4 rounded-xl border border-dashed border-yellow-500/50 flex justify-between items-center">
                    <span id="referral-code" class="text-xl font-mono font-bold text-yellow-400 tracking-widest">...</span>
                    <button onclick="copyReferralCode()" class="p-2 hover:bg-slate-800 rounded"><i data-lucide="copy" class="w-5 h-5"></i></button>
                </div>
                <button onclick="shareReferral()" class="w-full btn-accent p-3 rounded-xl flex items-center justify-center gap-2">
                    <i data-lucide="share-2" class="w-4 h-4"></i> Share Now
                </button>
                <div class="card-bg p-4 rounded-xl">
                    <label class="text-xs text-gray-400 block mb-2">Have a code?</label>
                    <div class="flex gap-2">
                        <input id="enter-referral-code" type="text" placeholder="Enter Code" class="flex-1 p-2 rounded bg-slate-900 border border-slate-700 text-center uppercase">
                        <button onclick="applyReferral()" class="bg-slate-700 hover:bg-slate-600 px-4 rounded font-bold text-sm">APPLY</button>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile-page" class="p-4 space-y-6 sub-page">
                <div class="text-center mt-4">
                    <div class="w-24 h-24 mx-auto rounded-full bg-slate-800 overflow-hidden border-4 border-slate-700">
                        <img id="profile-img" src="" class="w-full h-full object-cover">
                    </div>
                    <h2 id="profile-name" class="text-xl font-bold mt-3">...</h2>
                    <p id="profile-email" class="text-sm text-gray-400">...</p>
                </div>
                <div class="space-y-2">
                    <div class="card-bg p-4 rounded-xl flex justify-between cursor-pointer hover:bg-slate-800">
                        <span><i data-lucide="shield" class="inline w-4 h-4 mr-2 text-blue-500"></i> Privacy Policy</span>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-500"></i>
                    </div>
                    <button id="logout-btn" class="w-full card-bg p-4 rounded-xl flex justify-between text-red-400 hover:bg-red-500/10">
                        <span><i data-lucide="log-out" class="inline w-4 h-4 mr-2"></i> Logout</span>
                    </button>
                </div>
            </div>
            
             <!-- Notifications Page -->
            <div id="notifications-page" class="p-4 space-y-4 sub-page">
                 <div class="flex items-center gap-2 mb-4">
                    <i data-lucide="arrow-left" class="w-6 h-6 cursor-pointer" onclick="navigateTo('home-page')"></i>
                    <h2 class="text-xl font-bold">Notifications</h2>
                </div>
                <div id="notifications-list" class="space-y-3 text-center text-gray-400">Loading...</div>
            </div>
        </main>

        <nav class="bottom-nav sticky bottom-0 grid grid-cols-4 items-center text-center py-3 z-30">
            <a href="#" class="nav-link active" onclick="navigateTo('home-page')">
                <i data-lucide="home" class="mx-auto w-6 h-6"></i>
                <span class="text-[10px]">HOME</span>
            </a>
            <a href="#" class="nav-link" onclick="navigateTo('wallet-page')">
                <i data-lucide="wallet" class="mx-auto w-6 h-6"></i>
                <span class="text-[10px]">WALLET</span>
            </a>
            <a href="#" class="nav-link" onclick="navigateTo('refer-page')">
                <i data-lucide="users" class="mx-auto w-6 h-6"></i>
                <span class="text-[10px]">REFER</span>
            </a>
            <a href="#" class="nav-link" onclick="navigateTo('profile-page')">
                <i data-lucide="user" class="mx-auto w-6 h-6"></i>
                <span class="text-[10px]">PROFILE</span>
            </a>
        </nav>
    </div>

    <!-- Alert Modal -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[150] p-6 animate-fade">
        <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-xs text-center border border-slate-700">
            <div class="mb-4 text-yellow-400"><i data-lucide="info" class="w-10 h-10 mx-auto"></i></div>
            <p id="alert-message" class="mb-6 text-gray-200">Message goes here</p>
            <button onclick="closeAlert()" class="w-full bg-white text-black font-bold py-2 rounded-xl">OK</button>
        </div>
    </div>

    <script type="module">
        // Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyDSyXdeWqDD-3OFNZT6SMcJz0Nr7tSdTS0",
          authDomain: "reward-earn-money-32b24.firebaseapp.com",
          databaseURL: "https://reward-earn-money-32b24-default-rtdb.firebaseio.com",
          projectId: "reward-earn-money-32b24",
          storageBucket: "reward-earn-money-32b24.firebasestorage.app",
          messagingSenderId: "647603026182",
          appId: "1:647603026182:web:1bfe0a9dc3d8e4513f8687"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;
        let appConfig = { minWithdrawal: 5000, dailyAdLimit: 10 };

        // Globals
        window.showAlert = (msg) => {
            document.getElementById('alert-message').textContent = msg;
            document.getElementById('custom-alert').classList.remove('hidden');
        };
        window.closeAlert = () => document.getElementById('custom-alert').classList.add('hidden');
        
        window.navigateTo = (pageId) => {
            document.querySelectorAll('.sub-page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if(link.getAttribute('onclick').includes(pageId)) link.classList.add('active');
            });
            if(pageId === 'wallet-page') loadHistory();
            if(pageId === 'notifications-page') loadNotifications();
            setTimeout(() => lucide.createIcons(), 100);
        };

        // Auth Logic
        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('loader');
            loader.style.display = 'flex';
            if (user) {
                currentUser = user;
                try {
                    await fetchData();
                    document.getElementById('auth-section').classList.remove('active');
                    document.getElementById('app-container').classList.add('active');
                    updateUI();
                } catch (error) {
                    console.error("Data Load Error:", error);
                    userData = { name: "User", balance: 0, referralCode: "ERROR" };
                    document.getElementById('auth-section').classList.remove('active');
                    document.getElementById('app-container').classList.add('active');
                }
            } else {
                currentUser = null;
                document.getElementById('app-container').classList.remove('active');
                document.getElementById('auth-section').classList.add('active');
            }
            setTimeout(() => { loader.style.display = 'none'; }, 800);
        });

        async function fetchData() {
            if (!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            try {
                const snap = await getDoc(userRef);
                if (snap.exists()) {
                    userData = snap.data();
                } else {
                    const newUser = {
                        uid: currentUser.uid,
                        name: currentUser.email.split('@')[0],
                        email: currentUser.email,
                        balance: 50,
                        referralCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
                        dailyAdCount: 0,
                        lastAdDate: new Date().toISOString().split('T')[0],
                        createdAt: serverTimestamp()
                    };
                    await setDoc(userRef, newUser);
                    userData = newUser;
                }
            } catch (e) {
                console.error(e);
                throw e;
            }
        }

        function updateUI() {
            if (!userData) return;
            document.getElementById('coin-balance').textContent = userData.balance;
            document.getElementById('wallet-coin-balance').textContent = userData.balance;
            document.getElementById('profile-name').textContent = userData.name || "User";
            document.getElementById('profile-email').textContent = currentUser.email;
            document.getElementById('profile-img').src = `https://ui-avatars.com/api/?name=${userData.name}&background=1e293b&color=fbbf24`;
            document.getElementById('referral-code').textContent = userData.referralCode;
            
            const today = new Date().toISOString().split('T')[0];
            let count = (userData.lastAdDate === today) ? userData.dailyAdCount : 0;
            document.getElementById('ads-left-count').textContent = Math.max(0, appConfig.dailyAdLimit - count);
            lucide.createIcons();
        }

        // --- Signup Fix Applied Here ---
        document.getElementById('signup-btn').addEventListener('click', async () => {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-password').value;
            
            if(!name || !email || !pass) return showAlert("Fill all fields");
            
            document.getElementById('loader').style.display = 'flex';
            try {
                // 1. Create User
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                
                // 2. Create Doc (USING setDoc - CORRECT WAY)
                const newUser = {
                    uid: cred.user.uid,
                    name: name,
                    email: email,
                    balance: 50,
                    referralCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
                    dailyAdCount: 0,
                    lastAdDate: new Date().toISOString().split('T')[0],
                    createdAt: serverTimestamp()
                };
                
                // Using setDoc instead of updateDoc
                await setDoc(doc(db, "users", cred.user.uid), newUser);
                
                // Auth listener will handle redirect
            } catch(e) {
                console.error(e);
                let msg = e.message;
                if(msg.includes('email-already-in-use')) msg = "Email already used.";
                showAlert("Signup Failed: " + msg);
                document.getElementById('loader').style.display = 'none';
            }
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            if(!email || !pass) return showAlert("Fill all fields");
            document.getElementById('loader').style.display = 'flex';
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch(e) {
                showAlert("Login Failed: " + e.message);
                document.getElementById('loader').style.display = 'none';
            }
        });

        document.getElementById('show-signup').onclick = () => {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('signup-view').classList.remove('hidden');
        };
        document.getElementById('show-login').onclick = () => {
            document.getElementById('signup-view').classList.add('hidden');
            document.getElementById('login-view').classList.remove('hidden');
        };
        document.getElementById('logout-btn').onclick = () => signOut(auth);
        document.getElementById('notification-bell').onclick = () => window.navigateTo('notifications-page');

        // Feature Logic
        window.claimReward = async (type) => {
            if (!currentUser) return;
            const today = new Date().toISOString().split('T')[0];
            if(userData.lastAdDate !== today) userData.dailyAdCount = 0;
            if(userData.dailyAdCount >= appConfig.dailyAdLimit) return showAlert("Daily limit reached! Come back tomorrow.");

            if (typeof window.show_10352978 !== 'function') return showAlert("Ad network not ready. Check internet or AdBlocker.");

            const loader = document.getElementById('loader');
            loader.style.display = 'flex';
            try {
                if(type === 'interstitial') await window.show_10352978();
                else if(type === 'popup') await window.show_10352978('pop');
                else await window.show_10352978();

                const reward = (type === 'miniApp') ? 100 : 50;
                await updateDoc(doc(db, "users", currentUser.uid), {
                    balance: (userData.balance || 0) + reward,
                    dailyAdCount: (userData.dailyAdCount || 0) + 1,
                    lastAdDate: today
                });
                userData.balance += reward;
                userData.dailyAdCount += 1;
                userData.lastAdDate = today;
                updateUI();
                showAlert(`Success! You earned ${reward} coins.`);
            } catch(e) {
                console.log(e);
                showAlert("Ad closed early or failed to load.");
            } finally {
                loader.style.display = 'none';
            }
        };

        document.getElementById('withdraw-btn').onclick = async () => {
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            const method = document.getElementById('withdraw-method').value;
            const number = document.getElementById('payment-number').value;
            if(!amount || !method || !number) return showAlert("Please fill all details.");
            if(amount < appConfig.minWithdrawal) return showAlert(`Min withdrawal: ${appConfig.minWithdrawal}`);
            if(amount > userData.balance) return showAlert("Insufficient balance.");

            document.getElementById('loader').style.display = 'flex';
            try {
                await updateDoc(doc(db, "users", currentUser.uid), { balance: userData.balance - amount });
                await addDoc(collection(db, "withdrawals"), {
                    userId: currentUser.uid,
                    amount: amount,
                    method: method,
                    number: number,
                    status: "pending",
                    date: serverTimestamp()
                });
                userData.balance -= amount;
                updateUI();
                document.getElementById('withdraw-amount').value = "";
                showAlert("Withdrawal requested successfully!");
                loadHistory();
            } catch(e) {
                showAlert("Error: " + e.message);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        };

        async function loadHistory() {
            const list = document.getElementById('withdrawal-history-list');
            if(!currentUser) return;
            const q = query(collection(db, "withdrawals"), where("userId", "==", currentUser.uid), orderBy("date", "desc"), limit(10));
            try {
                const snap = await getDocs(q);
                list.innerHTML = "";
                if(snap.empty) { list.innerHTML = "<p class='text-center py-4'>No history found.</p>"; return; }
                snap.forEach(d => {
                    const data = d.data();
                    const statusColor = data.status === 'pending' ? 'text-yellow-400' : (data.status === 'paid' ? 'text-green-400' : 'text-red-400');
                    list.innerHTML += `
                        <div class="card-bg p-3 rounded-lg flex justify-between items-center border border-slate-700">
                            <div><p class="font-bold text-white">${data.amount} Coins</p><p class="text-xs text-gray-400">${data.method} • ${data.status}</p></div>
                            <div class="${statusColor}"><i data-lucide="clock" class="w-4 h-4"></i></div>
                        </div>`;
                });
                lucide.createIcons();
            } catch(e) {
                console.log(e);
                list.innerHTML = "<p class='text-center text-red-400 text-xs'>Create Index in Firebase Console.</p>";
            }
        }
        
        async function loadNotifications() {
             const list = document.getElementById('notifications-list');
             const q = query(collection(db, "notifications"), orderBy("createdAt", "desc"), limit(5));
             try {
                 const snap = await getDocs(q);
                 list.innerHTML = "";
                 if(snap.empty) { list.innerHTML = "<p class='py-10 opacity-50'>No new notifications.</p>"; return; }
                 snap.forEach(d => {
                     const data = d.data();
                     list.innerHTML += `<div class="card-bg p-4 rounded-xl text-left border border-slate-700"><h3 class="font-bold text-yellow-400 text-sm mb-1">${data.title}</h3><p class="text-xs text-gray-300">${data.message}</p></div>`;
                 });
             } catch(e) { console.log(e); }
        }

        window.copyReferralCode = () => { navigator.clipboard.writeText(userData.referralCode); showAlert("Code copied!"); };
        window.shareReferral = () => { if (navigator.share) { navigator.share({ title: 'Earn Money', text: `Use my code ${userData.referralCode} to join!`, url: window.location.href }); } else { window.copyReferralCode(); } };
        window.applyReferral = async () => {
            const code = document.getElementById('enter-referral-code').value.trim().toUpperCase();
            if(!code) return showAlert("Enter a code");
            if(userData.referredBy) return showAlert("Already used a code");
            if(code === userData.referralCode) return showAlert("Can't use own code");
            const loader = document.getElementById('loader');
            loader.style.display = 'flex';
            try {
                const q = query(collection(db, "users"), where("referralCode", "==", code));
                const snap = await getDocs(q);
                if(!snap.empty) {
                    const refDoc = snap.docs[0];
                    await updateDoc(refDoc.ref, { balance: (refDoc.data().balance || 0) + 100 });
                    await updateDoc(doc(db, "users", currentUser.uid), { balance: userData.balance + 100, referredBy: code });
                    userData.balance += 100;
                    userData.referredBy = code;
                    updateUI();
                    showAlert("Bonus Applied! +100 Coins");
                } else { showAlert("Invalid Code"); }
            } catch(e) { showAlert("Error applying code"); } finally { loader.style.display = 'none'; }
        };
        lucide.createIcons();
    </script>
</body>
    </html>



